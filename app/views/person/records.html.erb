<% if (request.referrer.match("/search") rescue false)
    session['list_url'] = '/search'
   else
     session['list_url'] = request.path
   end
%>


<style>
    .even, .odd{
        background: white !important;
    }
    .t-data{
        border: 1px dotted #d3d3d3;
        background: white;
    }
    th{
        background-color: lightsteelblue !important;
        color: black;
        padding: 10px !important;
    }
    #birth_type, #example_filter{
        margin-left: 15px;
        float: right;
        background:white;
    }

    #example_filter input{
        margin-bottom: 10px;
        font-size: 20px;
        padding: 5px;
        float: right;
        width: 250px;
        margin-left: 20px;
        margin-right: 30px;
    }

    #example_filter label{
        float: right;
    }
    .action-button{
        width: 70px !important;
        border-bottom: 1px solid ghostwhite !important;
    }

    .action-button div{
        margin: 2px !important;
        border-left: 1px solid #d3d3d3;
    }

    .action-button:hover, .action-button div:hover,
    .action-button:active, .action-button div:active,
    .white:hover, .white:active{
        background: white !important;
    }

     .paginate_button{
         font-size: 17px;
         font-weight: bold;
         padding: 13px !important;
         padding-left: 16px !important;
         padding-right: 16px !important;
     }
     .Edit_Record{
         display: none;
     }

     .btn-sync{
         height: 16px !important;width:16px !important;
     }
</style>
<div class='data-table-container'>

<table id="example" class="display" cellspacing="0" width="100%">
  <thead>
    <tr>
      <% if (@display_ben rescue false) %>
        <th style="text-align: left;">BEN</th>
      <% end %>
      <% if (@display_ver_num rescue false) %>
          <th style="text-align: left;width: 10%;">Approval Number</th>
      <% end %>
      <th style="text-align: left;min-width:12%;">Name</th>
      <th style="text-align: left;min-width:10%;">Birthdate</th>
      <th style="text-align: left;min-width:12%;">Mother's Details</th>
      <th style="text-align: left; min-width:12%;">Father's Details</th>
      <th style="text-align: center; min-width:13%;">Reporting Date</th>
      <th style="text-align: center;min-width: 10%;">Status</th>
      <th  style="text-align: left;min-width:10%;">&nbsp;</th>
    </tr>
  </thead>

  <tbody>


  <% display = SETTINGS['enable_role_privileges'] == false ? '' : 'none'
  %>

  <%(@records || []).each do |record|%>
      <tr>
        <% if (@display_ben rescue false) %>
            <td class='t-data' style="text-align: left;"><%= record['ben'] %></td>
        <% end %>
        <% if (@display_ver_num rescue false) %>
            <td class='t-data' style="text-align: left;"><%= record['vnum'] %></td>
        <% end %>
        <td class='t-data' style="text-align: left;"><%= record['name'] %></td>
        <td class='t-data' style="text-align: left;"><%= record['mother_name'] %></td>
        <td class='t-data' style="text-align: left;"><%= record['father_name'] %></td>
        <td class='t-data' style="text-align: center;"><%= record['date_of_reporting'] %></td>
        <td class='t-data' style="text-align: center;"><%=  record['status']%></td>
        <td class='t-data t-actions' style="background-color: white;">


          <table class='action-buttons' style="width: 100%; text-align: center; border-style: none;" cellpadding="0">
            <tr>
              <td class="action-button" onmousedown="window.location = '/person/<%= record['id']%>?next_path=<%= request.path%>'">
                <div url='/person/<%= record['id']%>?next_path=<%= request.path%>' class="btn btn-info"
                     >
                <%= image_tag "view.png", class: 'btn-images' %></div>
              </td>
              <td class="Edit_Record" onmousedown="window.location = '/person/<%= record['id']%>/edit?next_path=<%= request.path%>'"
                  style="display:<%= display%>;"
                  class="action-button">
                <div url='/person/<%= record['id']%>/edit?next_path=<%= request.path%>' class="btn btn-warning"
                        >
                <%= image_tag "edit.png", class: 'btn-images' %></div>
              </td>
              <td class="Void_Record"
                  style="display:<%= display%>;"
                  class="action-button">
                <div class="btn btn-success" onmousedown="javascript:alert();">
                <%= image_tag "void.png", class: 'btn-images' %></div>
              </td>
            </tr>
          </table>
      </tr>
    <%end%>
  </tbody>
</table>

</div>
<select id="birth_type" label="Birth Type" onchange="reloadDataTable(this)" style="width: 200px !important;
        padding: 5px; margin-right: 20px; font-size: 20px;"
        >
  <option value="All">Select Category</option>
  <option id="nid" >From NID</option>
  <option id="normal">Normal</option>
  <option id="abandoned">Abandoned</option>
  <option id="adopted">Adopted</option>
  <option id="orphaned">Orphaned</option>
</select>

<script>
    function enableDisableFileType(action){
        if(action == "disable"){
            $("#PDF").attr("disabled",true);
            $("#CSV").attr("disabled",true);
        }else{
            $("#PDF").removeAttr("disabled");
            $("#CSV").removeAttr("disabled");
        }
        
    }
</script>

<div id="dispatchPop" style=""> 
                <form  id="dipatchForm" method="GET" action="/do_dispatch_these">
                    <table id="dispatchModal">
                        <tr>
                            <th colspan="4"> Dispatch Criteria </th>
                        </tr>
                        <tr>
                            <td style="width:15%; border-right: 2px solid #D3D3D3">TA</td>
                            <td colspan="2"><input class="field" id="ta" name="ta" onfocus="fetchList('ta')"></td>
                            <td rowspan="6" style="width:40%; border-left: 2px solid #D3D3D3">
                                <div style="height: 350px; overflow-y:scroll">
                                    <ul id="list">

                                    </ul>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td style="width:15%; border-right: 2px solid #D3D3D3" >Village</td>
                            <td colspan="2"><input   class="field" id="village" name="village" onfocus="fetchList('village')"></td>
                        </tr>

                        <tr>
                            <td style="width:15%; border-right: 2px solid #D3D3D3" >Start Printed Date <span style="color:red">*</span></td>
                            <td colspan="2"><input class="field" id="start" name="start"></td>
                        </tr>
                        <tr>
                            <td style="width:15%; border-right: 2px solid #D3D3D3">End Printed Date</td>
                            <td colspan="2"><input class="field" id="end" name="end"></td>
                        </tr>
                        <tr>
                            <td style="width:15%; border-right: 2px solid #D3D3D3">Action <span style="color:red">*</span></td>
                            <td>
                                <input type="radio" id="print"  name="dispatch-action" value="print" onclick="enableDisableFileType('disable')" checked>
                                <label for="print" onclick="enableDisableFileType('disable')">Print</label>
                            </td>
                            <td>
                                <input type="radio" id="download" name="dispatch-action" value="download" onclick="enableDisableFileType('enable')">
                                <label for="download" onclick="enableDisableFileType('enable')">Download</label>
                            </td>
                        </tr>
                        <tr>
                            <td style ="width:15%; border-right: 2px solid #D3D3D3">File Type</td>
                            <td>
                                <input type="radio" id="PDF" name="file_type" value="PDF" disabled>
                                <label for="PDF">PDF</label>
                            </td>
                            <td>
                                <input type="radio" id="CSV" name="file_type" value="CSV" disabled>
                                <label for="CSV">CSV</label>
                            </td>
                        </tr>
                        <tr>
                            <td colspan= "2"></td>
                            <td> <button class="red"  onmousedown="hideDispatchModal()">Close</button></td>
                            <td > <button class="small blue" onmousedown="dispatch()">Proceed</button></td>
                        </tr>

                    </table>
                </form>
</div>
<style>
                    #dispatchModal  {
                        font-size: 1em;
                        width:98%;
                        margin-left:1%;
                    }
                    .field{
                        width:98%;
                        margin:1%;
                        height: 38px;
                        border: 1.5px solid #3465a4;
                        font-size: 1.5em;
                    }
                    #dispatchPop {
                        position:absolute;
                        top:10%;
                        left:20%;
                        width: 60%;
                        height: 480px; 
                        background: #ffffff; 
                        border: 1px solid #D3D3D3; 
                        box-shadow: 1px 2px #888888;
                        display: none
                    }

</style>
<% if @dispatch.present? && @dispatch %>
    <button class="blue" style="position: absolute; right: 180px; bottom: 20px; cursor: pointer;
                    border: 1px solid #fff; padding: 5px; border-radius: 50px; padding-top: 7px;" onmousedown="$('#dispatchPop').css('display','block')">
            Dispatch Records
    </button>
<%end%>  

<%= stylesheet_link_tag "jquery-ui/jquery-ui.min" %>
<%=javascript_include_tag "jquery-ui/jquery-ui.min.js"%>
<style>
    .ui-datepicker-prev , .ui-datepicker-next {
        background: #cdcdcd;
        color: #000000;
    }
    .ui-icon{
        color: black;
    }
</style>
<script>
    var district = "<%= @district.name %>";
    var ta = ""
    function fetchList(listType){
        
        if(listType == "ta"){
            $.get("/search_by_ta?district="+district,function(data){
                loadList(data.split("\n"),"ta")
            })
        }else if(listType == "village"){
            $.get("/search_by_village?district="+district+"&ta="+ta,function(data){
                loadList(data.split("\n"),"village")
            })
        }
    }

    function setInput(field,value){
        document.getElementById(field).value = value
        if(field == "ta"){
            ta = value;
        }
    }
    function loadList(list,field){
        $("#list").html("");
        var innerHTMLList = "";
        for(var i = 0; i < list.length; i++){
            innerHTMLList = innerHTMLList + "<li onclick= \"setInput('"+field+"','"+list[i]+"')\">"+list[i]+"</li>";
        }
        $("#list").html(innerHTMLList);
    }
    function hideDispatchModal(){
        $("#dipatchForm").submit(function(e){
            e.preventDefault()
        });
        $('#dispatchPop').css('display','none')
    }
    function dispatch(){
        $("#dipatchForm").submit(function(e){
            var values = $("#dipatchForm").serializeArray();
            for(var i =0 ; i < values.length ; i++ ){
                if(values[i].name == "start" && values[i].value.length == 0){
                    alert("Please select date printed")
                    e.preventDefault();
                    break;                    
                }
                if(values[i].name == "action" && values[i].value.length == 0){
                    alert("Please select action")
                    e.preventDefault();
                    break;                    
                }
            }
            
        })
    }


</script>
<script>

var table ;
var syncChecked = false;

$(document).ready(function() {
    initTable();
    $("#start").datepicker({dateFormat:'yy-mm-dd'});
    $("#end").datepicker({dateFormat:'yy-mm-dd'});
    var holder = __$('example_filter');
    holder.appendChild(__$('birth_type'));

    var search =__$('example_filter').getElementsByTagName("input")[0];
    search.setAttribute("onclick","changeFocusToMe(this)");
    searchData(search);
   
} );

search_value = '';
var ctrl;

function searchData(element) {
    if (element.value == 0 || search_value == element.value) {
        setTimeout(function () {
            searchData(element);
        }, 100)
    } else {
        search_value = element.value
        table.search(search_value).draw();
        setTimeout(function () {
            searchData(element);
        }, 100)
    }
}

var data = {};
var printed = false; //Hook for twins to avoid reprints

var url = "/person/paginated_data";
<% if params[:action] == 'searched_cases'%>
var url = "/person/paginated_search_data";

<% end %>

<% display = SETTINGS['enable_role_privileges'] == false ? '' : 'none'
  %>

<% if !@birth_type.blank? %>
   jQuery("#birth_type").find("#" + '<%= @birth_type.downcase%>').prop('selected', true);
   jQuery("#birth_type").prop('disabled', true);
<% end %>

function initTable(){
    table =  $('#example').DataTable(
            {
                "processing": true,
                "serverSide": true,
                'pageLength': 5,
                "ordering": false,
                "ajax": {
                    "url": url,
                    "data": function(d){
                        d.type = __$('birth_type').value;
                        d.statuses = "<%= @states.join(',')%>";
                        d.assign_ben = "<%= (@display_ben rescue false) ? true : false %>";
                        d.vnum = "<%= (@display_ver_num rescue false) ? true : false %>";
                        d.data = data;
                        <% if request.path.to_s.match("above_16")%>
                            d.by_ds_at_dro = true;
                        <% end %>
                    },
                    dataFilter: function(data){
                        var json = jQuery.parseJSON( data );
                        for(var i = 0; i < json['data'].length; i ++){
                            var last_index = json['data'][i].length - 1;
                            var person_id = json['data'][i][last_index];
                            json['data'][i][last_index] = "<table><tr class='white'>"
                            json['data'][i][last_index] +=
                                    '<td class="action-button"> ' +
                                        '<div onclick="javascript:location=\'/person/' + person_id + '?next_path=<%= request.path%> \'"     ' +
                                            'url=\'/person/' + person_id + '?next_path=<%= request.path%> \'"     ' +
                                            '    class="action-btn btn btn-success btn-xs">' +
                                            '<%= image_tag "view.png", class: 'btn-images' %></div>' +
                                    '</td>';

                            json['data'][i][last_index] +=
                                    '<td class="Edit_Record action-button"> ' +
                                    '<div onclick="javascript:location=\'/person/' + person_id + '/edit?next_path=<%= request.path%> \'"     ' +
                                    'url=\'/person/' + person_id + '/edit?next_path=<%= request.path%> \'"     ' +
                                    '    class="action-btn btn btn-success btn-xs">' +
                                    '<%= image_tag "edit.png", class: 'btn-images' %></div>' +
                                    '</td>';

                            <% if SETTINGS["application_mode"] == "FC" && !request.path.match("search")%>
                                json['data'][i][last_index] += '<td class="action-button"> ' +
                                '<div onclick="javascript:location=\'/person_id_label?person_id=' + person_id + '&next_path=<%= request.path%> \'"     ' +
                                'url=\'/person/' + person_id + '?next_path=<%= request.path%> \'"     ' +
                                '    class="action-btn btn btn-success btn-xs">' +
                                '<%= image_tag "printer2.png", class: 'btn-images' %></div>' +
                                '</td>';

                            <% end %>

                            json['data'][i][last_index] +=
                                    '<td class="sync" person_id='+ person_id + ' id='+ person_id + '> ' +
                                    '<div class="action-btn btn btn-success btn-xs">' +
                                    '<%= image_tag "", class: 'btn-images btn-sync' %></div>' +
                                    '</td>';


                            json['data'][i][last_index] += "</tr></table>"
                        }
                        return JSON.stringify( json );
                    }
                }}
    );


    table.on("draw.dt", function(){

        <% if !params[:person_id].blank? && SETTINGS['application_mode'] == "FC" && !params[:print_reg].blank? %>
            if (printed == false) {
                checkSerialNum();
            }
        <% end %>

        setTimeout("checkSync()", 250);
    });

}

function showSpinner(){

}

function checkSync(){
    var nodes = document.getElementsByClassName("sync");
   for (var i = 0; i < nodes.length; i ++){
       var person_id = nodes[i].getAttribute("person_id");
        jQuery.ajax({
            url: "/check_sync?person_id=" + person_id,
            success: function(data){
                data = JSON.parse(data);
                if (data['result'] == 'true'){
                    try {
                        var td = document.getElementById(data['person_id']).getElementsByClassName("btn-sync")[0];
                        console.log(td)
                        td.src = "/tick.png";
                    }catch(e){}
                }
            }
        })
   }
}

function reloadDataTable(node){
    table.ajax.reload();
}

function changeFocusToMe(control){

    if(control) {
        ctrl = control;
        if(__$("cursor_for_" + control.id)){
            if(__$("cursor")){
                    __$("cursor_for_" + control.id).appendChild(__$("cursor"));

                }
        }
        showKeyboard(control)
    }
}

setInterval(function(){
    <%
      (@actions || []).each do |action|
      next if (SETTINGS['enable_role_privileges'] == false)
    %>
        var clas = "<%= action['button_name'].gsub(/\s+/, '_') %>";
        $("." + clas).show();
        <% end %>
    }, 200)


function checkSerialNum(){
		
		jQuery.ajax({
			url: "/check_serial_number?person_id=<%=params[:person_id]%>",
			success: function(result){

				if(result.match(/^P/)){
                    printed = true;
                    window.location = "/person_id_label?person_id=<%=params[:person_id]%>";
				}else{
					setTimeout(function(){
						checkSerialNum();
					}, 200)						
				}
			}
		})		
	}	

</script>

<% if params[:action] == 'searched_cases'%>
    <style>
        #example_processing, #spin{
            display: none !important;
        }
        .Edit_Record{
            display: none !important;
        }

    </style>
<% end %>

<% if SETTINGS['application_mode'] == 'FC' %>
    <style>
        #birth_type{
            display: none !important;
        }

    </style>
<% end %>

